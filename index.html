<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RoutineFlow - Guided Routines (ADHD Friendly)</title>
    <link rel="manifest" href="/manifest.json">
    <style>
        /* CSS Variables for Easier Theming */
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --text-color: #333;
            --light-text-color: #6c757d;
            --background-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --white-background: white;
            --light-background: #f8f9fa;
            --border-color: #e9ecef;
            --active-border-color: #667eea;
            --active-background-light: #e7f3ff;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            --shadow: 0 0 50px rgba(0,0,0,0.3);
            --border-radius-card: 12px;
            --border-radius-btn: 25px;
            --border-radius-input: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background: var(--background-gradient);
            min-height: 100vh;
            color: var(--text-color);
            overflow-x: hidden;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: var(--white-background);
            min-height: 100vh;
            position: relative;
            box-shadow: var(--shadow);
        }

        .header {
            background: var(--background-gradient);
            color: var(--white-background);
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .nav-tabs {
            display: flex;
            background: var(--light-background);
            border-bottom: 1px solid var(--border-color);
        }

        .tab {
            flex: 1;
            padding: 15px 10px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--light-text-color);
            transition: all 0.2s ease;
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            background: var(--white-background);
        }

        .tab-content {
            display: none;
            padding: 20px;
            min-height: calc(100vh - 140px); /* Adjust based on header/nav height */
        }

        .tab-content.active {
            display: block;
        }

        .routine-card {
            background: var(--light-background);
            border-radius: var(--border-radius-card);
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .routine-card:hover {
            background: var(--border-color);
            transform: translateY(-1px);
        }

        .routine-card.active {
            border-color: var(--active-border-color);
            background: var(--active-background-light);
        }

        .routine-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .routine-title {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--text-color);
        }

        .routine-time {
            color: var(--light-text-color);
            font-size: 0.85rem;
            font-weight: 500;
        }

        .routine-tasks {
            color: var(--light-text-color);
            font-size: 0.8rem;
        }

        .routine-emoji {
            font-size: 1.2rem;
            margin-right: 8px;
        }

        .timer-view {
            text-align: center;
            padding: 40px 20px;
        }

        .timer-circle {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: var(--background-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px;
            color: var(--white-background);
            font-size: 2rem;
            font-weight: 700;
            position: relative;
            overflow: hidden;
        }

        .timer-progress {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.2);
            transform-origin: bottom;
            transform: scaleY(0); /* Start at 0 progress */
            transition: transform 0.5s ease-out; /* Smoother progress animation */
        }

        .current-task {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-color);
        }

        .task-emoji {
            font-size: 2rem;
            margin-bottom: 15px;
        }

        .timer-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .btn {
            background: var(--primary-color);
            color: var(--white-background);
            border: none;
            padding: 12px 24px;
            border-radius: var(--border-radius-btn);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn:hover {
            background: #5a6fd8; /* Slightly darker primary */
            transform: translateY(-1px);
        }

        .btn.secondary {
            background: var(--light-text-color);
        }

        .btn.secondary:hover {
            background: #5a6268; /* Slightly darker secondary */
        }

        .btn.success {
            background: var(--success-color);
        }

        .btn.success:hover {
            background: #218838; /* Slightly darker success */
        }

        .add-routine {
            background: var(--light-background);
            border: 2px dashed #dee2e6;
            border-radius: var(--border-radius-card);
            padding: 20px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.2s ease;
        }

        .add-routine:hover {
            border-color: var(--primary-color);
            background: var(--active-background-light);
        }

        .add-routine-icon {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center; /* Center horizontally and vertically */
            justify-content: center; /* Center horizontally and vertically */
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--white-background);
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative; /* For the close button positioning */
        }

        .modal-content h3 {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--light-text-color);
            padding: 0;
            line-height: 1; /* For better vertical alignment */
        }

        .modal-close-btn:hover {
            color: var(--text-color);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-input);
            font-size: 1rem;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .task-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--light-background);
            border-radius: var(--border-radius-input);
            margin-bottom: 10px;
            position: relative; /* For remove button positioning */
        }

        .task-item input[type="text"] {
            flex: 1;
            border: none;
            background: none;
            font-size: 0.9rem;
            padding: 0; /* Override default padding */
        }

        .task-item input[type="text"]:focus {
            outline: none;
        }

        .task-item input[type="number"] {
            width: 70px; /* Adjusted width */
            flex-shrink: 0;
            border: none;
            background: none;
            text-align: right; /* Align numbers right */
            -moz-appearance: textfield; /* Hide arrows in Firefox */
        }
        /* Hide arrows for Chrome, Safari, Edge */
        .task-item input[type="number"]::-webkit-outer-spin-button,
        .task-item input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .task-item .remove-task {
            background: none;
            border: none;
            color: var(--danger-color);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0 5px; /* Added padding */
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }
        .task-item .remove-task:hover {
            opacity: 1;
        }


        .emoji-picker {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 5px;
            margin-top: 10px;
        }

        .emoji-option {
            padding: 8px;
            border: none;
            background: var(--light-background);
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s ease;
        }

        .emoji-option:hover, .emoji-option.selected {
            background: var(--primary-color);
            color: var(--white-background);
        }

        .progress-bar {
            background: var(--border-color);
            height: 6px;
            border-radius: 3px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: var(--background-gradient);
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--light-background);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--light-text-color);
            text-transform: uppercase;
            font-weight: 600;
        }

        .completion-animation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4rem;
            z-index: 1001;
            animation: celebrationPop 1s ease-out forwards; /* Use forwards to keep final state */
            pointer-events: none; /* Allow clicks through */
        }

        @keyframes celebrationPop {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0; } /* Fade out */
        }

        .hidden {
            display: none !important; /* Use !important to ensure override */
        }

        .task-list {
            margin-top: 15px;
        }

        .task-preview {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--white-background);
            border-radius: 6px;
            margin-bottom: 5px;
            font-size: 0.85rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); /* Subtle shadow */
        }

        /* New styles for edit/delete buttons */
        .routine-actions {
            margin-top: 15px;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .routine-actions .action-btn {
            background: none;
            border: 1px solid var(--border-color);
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--light-text-color);
        }
        .routine-actions .action-btn:hover {
            background: var(--light-background);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        .routine-actions .action-btn.delete {
            color: var(--danger-color);
            border-color: var(--danger-color);
        }
        .routine-actions .action-btn.delete:hover {
            background: var(--danger-color);
            color: white;
        }

        /* Motivational message animations */
        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(0); opacity: 1; }
            to { transform: translateX(-50%) translateY(-100%); opacity: 0; }
        }

        /* Accessibility focus styles */
        .keyboard-navigation button:focus,
        .keyboard-navigation input:focus,
        .keyboard-navigation .routine-card:focus,
        .keyboard-navigation .add-routine:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>RoutineFlow</h1>
            <p>Design your ideal day. Every day.</p>
        </div>

        <div class="nav-tabs">
            <button class="tab active" onclick="switchTab('routines')">Routines</button>
            <button class="tab" onclick="switchTab('timer')">Timer</button>
            <button class="tab" onclick="switchTab('analytics')">Analytics</button>
        </div>

        <div id="routines" class="tab-content active">
            <div class="add-routine" onclick="showRoutineModal('add')" tabindex="0">
                <div class="add-routine-icon">+</div>
                <div>Create New Routine</div>
            </div>

            <div id="routines-list">
                </div>
        </div>

        <div id="timer" class="tab-content">
            <div id="timer-inactive" class="timer-view">
                <div style="text-align: center; padding: 60px 20px; color: var(--light-text-color);">
                    <div style="font-size: 3rem; margin-bottom: 20px;">‚è∞</div>
                    <h3>Select a routine to start</h3>
                    <p>Choose a routine from the Routines tab to begin your guided session</p>
                </div>
            </div>

            <div id="timer-active" class="timer-view hidden">
                <div class="task-emoji" id="current-task-emoji">üåÖ</div>
                <div class="current-task" id="current-task-name">Morning Routine</div>
                <div class="timer-circle">
                    <div class="timer-progress" id="timer-progress"></div>
                    <div id="timer-display">05:00</div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="routine-progress" style="width: 0%"></div>
                </div>
                <div style="color: var(--light-text-color); margin-bottom: 20px;">
                    Task <span id="current-task-index">1</span> of <span id="total-tasks">5</span>
                </div>
                <div class="timer-controls">
                    <button class="btn secondary" onclick="pauseTimer()">Pause</button>
                    <button class="btn success" onclick="completeTask()">Complete</button>
                    <button class="btn secondary" onclick="skipTask()">Skip</button>
                </div>
            </div>
        </div>

        <div id="analytics" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="streak-count">0</div>
                    <div class="stat-label">Day Streak</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="completed-routines">0</div>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-time">0m</div>
                    <div class="stat-label">Total Time</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avg-time">0m</div>
                    <div class="stat-label">Avg Time</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-points">0</div>
                    <div class="stat-label">Total Points</div>
                </div>
                </div>

            <div style="background: var(--light-background); padding: 20px; border-radius: var(--border-radius-card); text-align: center;">
                <h3 style="margin-bottom: 15px; color: var(--text-color);">Weekly Progress</h3>
                <div style="display: flex; justify-content: space-between; align-items: end; height: 100px; margin-bottom: 10px;" id="weekly-chart">
                    </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--light-text-color);">
                    <span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span><span>Sun</span>
                </div>
            </div>

            <div style="background: var(--light-background); padding: 20px; border-radius: var(--border-radius-card); text-align: center; margin-top: 20px;">
                <h3 style="margin-bottom: 15px; color: var(--text-color);">Achievements</h3>
                <div id="achievements-list" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 15px;">
                    <div id="achievement-first-routine" class="hidden" style="text-align: center;">
                        <span style="font-size: 2.5rem;">‚≠ê</span><br>
                        <span style="font-size: 0.9rem; font-weight: 600; color: var(--text-color);">First Routine!</span>
                    </div>
                    <div id="achievement-consistent-week" class="hidden" style="text-align: center;">
                        <span style="font-size: 2.5rem;">‚úÖ</span><br>
                        <span style="font-size: 0.9rem; font-weight: 600; color: var(--text-color);">Consistent Week!</span>
                    </div>
                    <div id="achievement-points-500" class="hidden" style="text-align: center;">
                        <span style="font-size: 2.5rem;">üéâ</span><br>
                        <span style="font-size: 0.9rem; font-weight: 600; color: var(--text-color);">Point Pro!</span>
                    </div>
                    <div id="achievement-points-1000" class="hidden" style="text-align: center;">
                        <span style="font-size: 2.5rem;">üèÜ</span><br>
                        <span style="font-size: 0.9rem; font-weight: 600; color: var(--text-color);">Routine Master!</span>
                    </div>
                </div>
                <p id="no-achievements-msg" style="color: var(--light-text-color); margin-top: 10px;">Keep completing routines to unlock achievements!</p>
            </div>
            </div>
    </div>

    <div id="routine-modal" class="modal">
        <div class="modal-content">
            <h3><span id="modal-title">Create New Routine</span> <button class="modal-close-btn" onclick="hideRoutineModal()">&times;</button></h3>
            
            <div class="form-group">
                <label for="routine-name">Routine Name</label>
                <input type="text" id="routine-name" placeholder="Morning Routine" />
            </div>

            <div class="form-group">
                <label>Routine Emoji</label>
                <div class="emoji-picker" id="routine-emoji-picker">
                    <button class="emoji-option selected" data-emoji="üåÖ">üåÖ</button>
                    <button class="emoji-option" data-emoji="üåô">üåô</button>
                    <button class="emoji-option" data-emoji="üí™">üí™</button>
                    <button class="emoji-option" data-emoji="üßò">üßò</button>
                    <button class="emoji-option" data-emoji="üìö">üìö</button>
                    <button class="emoji-option" data-emoji="üèÉ">üèÉ</button>
                    <button class="emoji-option" data-emoji="üçé">üçé</button>
                    <button class="emoji-option" data-emoji="üßπ">üßπ</button>
                </div>
            </div>

            <div class="form-group">
                <label>Tasks</label>
                <div id="tasks-list">
                    </div>
                <button type="button" class="btn" onclick="addTask()" style="margin-top: 10px; padding: 8px 16px;">+ Add Task</button>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 30px;">
                <button class="btn secondary" onclick="hideRoutineModal()" style="flex: 1;">Cancel</button>
                <button class="btn" id="save-routine-btn" onclick="saveRoutine()" style="flex: 1;">Save Routine</button>
            </div>
        </div>
    </div>

    <script>
        // Application State
        let routines = JSON.parse(localStorage.getItem('routines') || '[]');
        let analytics = JSON.parse(localStorage.getItem('analytics') || '{"streak": 0, "completed": 0, "totalTime": 0, "weeklyData": [0,0,0,0,0,0,0], "totalPoints": 0, "achievements": {}}'); // Added totalPoints and achievements

        // Define achievements and their criteria
        const achievementsList = {
            "first-routine": { // Key must match id for pre-defined HTML divs (e.g., achievement-first-routine)
                name: "First Routine!",
                emoji: "‚≠ê",
                criteria: (stats) => stats.completed >= 1
            },
            "consistent-week": {
                name: "Consistent Week!",
                emoji: "‚úÖ",
                criteria: (stats) => stats.weeklyData.every(day => day >= 1) // At least one routine completed each day of the week
            },
            "points-500": {
                name: "Point Pro!",
                emoji: "üéâ",
                criteria: (stats) => stats.totalPoints >= 500
            },
            "points-1000": {
                name: "Routine Master!",
                emoji: "üèÜ",
                criteria: (stats) => stats.totalPoints >= 1000
            }
            // Add more achievements here using the format:
            // "my-custom-achievement": {
            //     name: "My Custom Badge",
            //     emoji: "‚ú®",
            //     criteria: (stats) => stats.completed >= 10 && stats.streak >= 5
            // }
        };


        let currentRoutine = null;
        let currentTaskIndex = 0;
        let timer = null;
        let timeRemaining = 0;
        let isPaused = false;
        let editingRoutineId = null; // To track which routine is being edited

        // Default routines (only if no routines exist in local storage)
        if (routines.length === 0) {
            routines = [
                {
                    id: 1,
                    name: "Morning Routine",
                    emoji: "üåÖ",
                    tasks: [
                        { name: "Drink water", emoji: "üíß", duration: 2 },
                        { name: "Stretch", emoji: "ü§∏", duration: 5 },
                        { name: "Make bed", emoji: "üõèÔ∏è", duration: 3 },
                        { name: "Brush teeth", emoji: "ü¶∑", duration: 3 },
                        { name: "Meditate", emoji: "üßò", duration: 10 }
                    ]
                },
                {
                    id: 2,
                    name: "Evening Routine",
                    emoji: "üåô",
                    tasks: [
                        { name: "Read book", emoji: "üìö", duration: 15 },
                        { name: "Journal", emoji: "üìù", duration: 10 },
                        { name: "Brush teeth", emoji: "ü¶∑", duration: 3 },
                        { name: "Skincare", emoji: "üß¥", duration: 5 }
                    ]
                }
            ];
            saveRoutines();
        }

        // Initialize on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function() {
            renderRoutines();
            updateAnalytics();
            generateWeeklyChart();
            displayAchievements(); // NEW: Display achievements on load
            requestNotificationPermission(); // Request permission on load
            loadSavedProgress(); // Load progress on page load
        });

        // Tab switching logic
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');
            // Ensure timer is paused if switching away from timer tab
            if (tabName !== 'timer' && currentRoutine && !isPaused) {
                pauseTimer(); 
            }
        }

        // Render routines list in the 'Routines' tab
        function renderRoutines() {
            const list = document.getElementById('routines-list');
            list.innerHTML = '';

            if (routines.length === 0) {
                list.innerHTML = `<div style="text-align: center; padding: 40px 20px; color: var(--light-text-color);">
                                    <div style="font-size: 3rem; margin-bottom: 20px;">üßò</div>
                                    <h3>No routines yet!</h3>
                                    <p>Click 'Create New Routine' to get started.</p>
                                  </div>`;
                return;
            }

            routines.forEach(routine => {
                const totalTime = routine.tasks.reduce((sum, task) => sum + task.duration, 0);
                const card = document.createElement('div');
                card.className = 'routine-card';
                card.setAttribute('tabindex', '0'); // Make focusable for accessibility
                card.setAttribute('role', 'button'); // Indicate it's clickable

                card.innerHTML = `
                    <div class="routine-header">
                        <div>
                            <span class="routine-emoji">${routine.emoji}</span>
                            <span class="routine-title">${routine.name}</span>
                        </div>
                        <div class="routine-time">${totalTime} min</div>
                    </div>
                    <div class="routine-tasks">${routine.tasks.length} tasks</div>
                    <div class="task-list">
                        ${routine.tasks.map(task => `
                            <div class="task-preview">
                                <span>${task.emoji || '‚ú®'}</span>
                                <span>${task.name}</span>
                                <span style="margin-left: auto; color: var(--light-text-color); font-size: 0.8rem;">${task.duration}m</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="routine-actions">
                        <button class="action-btn" onclick="event.stopPropagation(); showRoutineModal('edit', ${routine.id})" aria-label="Edit ${routine.name}">Edit</button>
                        <button class="action-btn delete" onclick="event.stopPropagation(); deleteRoutine(${routine.id})" aria-label="Delete ${routine.name}">Delete</button>
                    </div>
                `;
                
                // Use event delegation for click and keyboard activation
                card.addEventListener('click', () => startRoutine(routine));
                card.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault(); // Prevent default scroll for spacebar
                        startRoutine(routine);
                    }
                });

                list.appendChild(card);
            });
        }

        // Delete routine functionality
        function deleteRoutine(id) {
            if (confirm('Are you sure you want to delete this routine? This action cannot be undone.')) {
                routines = routines.filter(r => r.id !== id);
                saveRoutines();
                renderRoutines();
                // If the deleted routine was the active one in timer, reset timer
                if (currentRoutine && currentRoutine.id === id) {
                    resetTimer();
                }
            }
        }

        // Start a selected routine
        function startRoutine(routine) {
            currentRoutine = routine;
            currentTaskIndex = 0;
            isPaused = false; // Ensure timer starts unpaused
            switchTab('timer');
            startCurrentTask();
        }

        // Start the current task in the routine
        function startCurrentTask() {
            // Check if routine is complete or invalid
            if (!currentRoutine || currentTaskIndex >= currentRoutine.tasks.length) {
                completeRoutine();
                return;
            }

            const task = currentRoutine.tasks[currentTaskIndex];
            timeRemaining = task.duration * 60; // Convert minutes to seconds
            
            document.getElementById('timer-inactive').classList.add('hidden');
            document.getElementById('timer-active').classList.remove('hidden');
            
            document.getElementById('current-task-emoji').textContent = task.emoji || '‚ú®'; // Fallback emoji
            document.getElementById('current-task-name').textContent = task.name;
            document.getElementById('current-task-index').textContent = currentTaskIndex + 1;
            document.getElementById('total-tasks').textContent = currentRoutine.tasks.length;
            
            updateTimerDisplay();
            updateTimerProgress();
            updateRoutineProgress();
            startTimerInterval();
        }

        // Timer interval management
        function startTimerInterval() {
            if (timer) clearInterval(timer); // Clear any existing timer

            timer = setInterval(() => {
                if (!isPaused && timeRemaining > 0) {
                    timeRemaining--;
                    updateTimerDisplay();
                    updateTimerProgress();
                    
                    if (timeRemaining === 0) {
                        completeTask();
                    }
                }
            }, 1000); // Update every second
        }

        // Pause/Resume timer
        function pauseTimer() {
            isPaused = !isPaused;
            document.querySelector('.timer-controls .btn.secondary').textContent = isPaused ? 'Resume' : 'Pause';
            if (!isPaused) {
                startTimerInterval(); // Resume timer
            } else {
                clearInterval(timer); // Pause timer
            }
        }

        // Mark current task as complete and move to next
        function completeTask() {
            // Add points for completing the task (duration is a good base)
            if (currentRoutine && currentTaskIndex < currentRoutine.tasks.length) {
                const task = currentRoutine.tasks[currentTaskIndex];
                const pointsEarned = task.duration * 10; // Example: 10 points per minute of task
                analytics.totalPoints += pointsEarned;
                saveAnalytics(); // Save analytics immediately
                updateAnalytics(); // Update display
                showNotification('Task Complete!', `"${task.name}" finished. +${pointsEarned} points!`);
            } else {
                // Fallback notification if task details aren't perfectly aligned
                showNotification('Task Complete!', `Task finished.`);
            }

            showCompletionAnimation(); // Visual feedback
            
            setTimeout(() => {
                currentTaskIndex++;
                startCurrentTask(); // Move to the next task or complete routine
            }, 1000); // Delay for animation
        }

        // Skip current task and move to next
        function skipTask() {
            currentTaskIndex++;
            startCurrentTask();
        }

        // Complete the entire routine
        function completeRoutine() {
            clearInterval(timer); // Stop the timer
            timer = null; // Clear timer reference

            // Update analytics
            analytics.completed++;
            analytics.totalTime += currentRoutine.tasks.reduce((sum, task) => sum + task.duration, 0);
            
            // Streak logic
            const today = new Date();
            const todayDateString = today.toDateString(); // e.g., "Tue Jul 01 2025"
            const lastCompletionDate = localStorage.getItem('lastCompletionDate');

            if (lastCompletionDate) {
                const lastDate = new Date(lastCompletionDate);
                const dayBeforeToday = new Date(today);
                dayBeforeToday.setDate(today.getDate() - 1);

                if (lastDate.toDateString() === dayBeforeToday.toDateString()) {
                    analytics.streak++; // Completed yesterday, continue streak
                } else if (lastDate.toDateString() !== todayDateString) {
                    // If not yesterday and not today, it's a new streak
                    analytics.streak = 1; 
                }
                // If lastDate is todayDateString, it means user completed multiple routines today, streak doesn't change
            } else {
                analytics.streak = 1; // First completion, start streak
            }
            localStorage.setItem('lastCompletionDate', todayDateString);

            // Update weekly data (map Sunday=0 to index 6 for array, Monday=1 to index 0 etc.)
            analytics.weeklyData[today.getDay() === 0 ? 6 : today.getDay() - 1]++;
            
            saveAnalytics();
            updateAnalytics();
            generateWeeklyChart();
            checkAchievements(); // NEW: Check for achievements after routine completion
            
            // Show routine completion message
            document.getElementById('timer-active').classList.add('hidden');
            document.getElementById('timer-inactive').innerHTML = `
                <div style="text-align: center; padding: 60px 20px;">
                    <div style="font-size: 4rem; margin-bottom: 20px;">üéâ</div>
                    <h3 style="color: var(--success-color);">Routine Complete!</h3>
                    <p style="color: var(--light-text-color); margin: 15px 0;">Great job finishing your ${currentRoutine.name}!</p>
                    <button class="btn" onclick="resetTimer()">Start Another Routine</button>
                </div>
            `;
            document.getElementById('timer-inactive').classList.remove('hidden');
            showMotivationalMessage(); // Show a motivational quote
            currentRoutine = null; // Clear current routine after completion
        }

        // Reset timer view to initial state
        function resetTimer() {
            document.getElementById('timer-inactive').innerHTML = `
                <div style="text-align: center; padding: 60px 20px; color: var(--light-text-color);">
                    <div style="font-size: 3rem; margin-bottom: 20px;">‚è∞</div>
                    <h3>Select a routine to start</h3>
                    <p>Choose a routine from the Routines tab to begin your guided session</p>
                </div>
            `;
            currentRoutine = null;
            clearInterval(timer);
            timer = null;
            isPaused = false;
            document.querySelector('.timer-controls .btn.secondary').textContent = 'Pause';
            switchTab('routines'); // Go back to routines tab
        }

        // Update timer display (MM:SS format)
        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timer-display').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Update circular timer progress animation
        function updateTimerProgress() {
            if (currentRoutine && currentTaskIndex < currentRoutine.tasks.length) {
                const task = currentRoutine.tasks[currentTaskIndex];
                const totalSeconds = task.duration * 60;
                // Calculate progress as a value from 0 to 1 for scaleY
                const progress = totalSeconds > 0 ? (totalSeconds - timeRemaining) / totalSeconds : 1;
                document.getElementById('timer-progress').style.transform = `scaleY(${progress})`;
            }
        }

        // Update overall routine progress bar
        function updateRoutineProgress() {
            if (currentRoutine) {
                const progress = (currentTaskIndex / currentRoutine.tasks.length) * 100;
                document.getElementById('routine-progress').style.width = `${progress}%`;
            }
        }

        // Show a brief completion animation
        function showCompletionAnimation() {
            const animation = document.createElement('div');
            animation.className = 'completion-animation';
            animation.textContent = '‚ú®';
            document.body.appendChild(animation);
            
            // Remove animation after its duration
            setTimeout(() => {
                if (document.body.contains(animation)) {
                    document.body.removeChild(animation);
                }
            }, 1000);
        }

        // Modal functions (for Add/Edit Routine)
        function showRoutineModal(mode, id = null) {
            const modal = document.getElementById('routine-modal');
            const routineNameInput = document.getElementById('routine-name');
            const tasksList = document.getElementById('tasks-list');
            const modalTitle = document.getElementById('modal-title');
            const saveButton = document.getElementById('save-routine-btn');

            editingRoutineId = id; // Set the ID if in edit mode

            // Reset modal state
            routineNameInput.value = '';
            tasksList.innerHTML = '';
            document.querySelectorAll('.emoji-option').forEach(opt => opt.classList.remove('selected'));
            document.querySelector('.emoji-option[data-emoji="üåÖ"]').classList.add('selected'); // Default emoji

            if (mode === 'add') {
                modalTitle.textContent = 'Create New Routine';
                saveButton.textContent = 'Save Routine';
                addTask(document.querySelector('.emoji-option.selected').dataset.emoji, 'New Task', 5); // Add a default task for new routine
            } else if (mode === 'edit' && id !== null) {
                const routineToEdit = routines.find(r => r.id === id);
                if (!routineToEdit) {
                    console.error('Routine not found for editing:', id);
                    hideRoutineModal();
                    return;
                }

                modalTitle.textContent = 'Edit Routine';
                saveButton.textContent = 'Update Routine';
                routineNameInput.value = routineToEdit.name;

                // Set selected emoji
                const selectedEmojiBtn = document.querySelector(`.emoji-option[data-emoji="${routineToEdit.emoji}"]`);
                if (selectedEmojiBtn) {
                    selectedEmojiBtn.classList.add('selected');
                } else {
                    document.querySelector('.emoji-option[data-emoji="üåÖ"]').classList.add('selected'); // Fallback to default
                }

                // Populate tasks
                if (routineToEdit.tasks.length > 0) {
                    routineToEdit.tasks.forEach(task => {
                        addTask(task.emoji, task.name, task.duration);
                    });
                } else {
                    addTask(document.querySelector('.emoji-option.selected').dataset.emoji, 'New Task', 5); // If routine has no tasks, add one
                }
            }
            
            modal.classList.add('active');
            routineNameInput.focus(); // Focus on the first input
        }

        function hideRoutineModal() {
            document.getElementById('routine-modal').classList.remove('active');
            editingRoutineId = null; // Clear editing state
        }

        // Add a new task row to the modal
        function addTask(emoji = null, name = '', duration = 5) {
            const tasksList = document.getElementById('tasks-list');
            const taskItem = document.createElement('div');
            taskItem.className = 'task-item';

            // Use the currently selected routine emoji as the default for new tasks
            const defaultEmojiForTask = emoji || document.querySelector('.emoji-option.selected')?.dataset.emoji || '‚ú®';

            taskItem.innerHTML = `
                <span>${defaultEmojiForTask}</span>
                <input type="text" placeholder="Task name" value="${name}" aria-label="Task name" />
                <input type="number" placeholder="5" value="${duration}" min="1" max="60" aria-label="Task duration in minutes" />
                <span style="font-size: 0.8rem; color: var(--light-text-color);">min</span>
                <button class="remove-task" onclick="removeTask(this)" aria-label="Remove task">&times;</button>
            `;
            tasksList.appendChild(taskItem);
            taskItem.querySelector('input[type="text"]').focus(); // Focus on the new task input
        }

        // Remove a task row from the modal
        function removeTask(buttonElement) {
            const tasksList = document.getElementById('tasks-list');
            if (tasksList.children.length > 1) { // Ensure at least one task remains
                buttonElement.closest('.task-item').remove();
            } else {
                alert('A routine must have at least one task.');
            }
        }

        // Save or Update a routine
        function saveRoutine() {
            const name = document.getElementById('routine-name').value.trim();
            const selectedEmoji = document.querySelector('.emoji-option.selected').dataset.emoji;
            const taskItems = document.querySelectorAll('#tasks-list .task-item');
            
            if (!name) {
                alert('Please enter a routine name.');
                return;
            }
            
            const tasks = [];
            taskItems.forEach(item => {
                const taskEmojiSpan = item.querySelector('span'); // Get the task's emoji span
                const taskEmoji = taskEmojiSpan ? taskEmojiSpan.textContent : '‚ú®'; // Fallback for task emoji
                const taskName = item.querySelector('input[type="text"]').value.trim();
                const duration = parseInt(item.querySelector('input[type="number"]').value) || 5;
                
                if (taskName) {
                    tasks.push({ name: taskName, emoji: taskEmoji, duration });
                }
            });
            
            if (tasks.length === 0) {
                alert('Please add at least one task.');
                return;
            }
            
            if (editingRoutineId) {
                // Update existing routine
                routines = routines.map(r => 
                    r.id === editingRoutineId ? { ...r, name, emoji: selectedEmoji, tasks } : r
                );
            } else {
                // Add new routine
                const newRoutine = {
                    id: Date.now(), // Unique ID for new routine
                    name,
                    emoji: selectedEmoji,
                    tasks
                };
                routines.push(newRoutine);
            }
            
            saveRoutines();
            renderRoutines();
            hideRoutineModal();
        }

        // Emoji picker logic (using event delegation for efficiency)
        document.getElementById('routine-emoji-picker').addEventListener('click', function(e) {
            if (e.target.classList.contains('emoji-option')) {
                document.querySelectorAll('.emoji-option').forEach(opt => opt.classList.remove('selected'));
                e.target.classList.add('selected');
            }
        });
        
        // Analytics functions
        function updateAnalytics() {
            document.getElementById('streak-count').textContent = analytics.streak;
            document.getElementById('completed-routines').textContent = analytics.completed;
            document.getElementById('total-time').textContent = `${analytics.totalTime}m`;
            document.getElementById('avg-time').textContent = analytics.completed > 0 ? 
                `${Math.round(analytics.totalTime / analytics.completed)}m` : '0m';
            document.getElementById('total-points').textContent = analytics.totalPoints; // NEW: Update total points
            displayAchievements(); // NEW: Refresh achievement display
        }

        // Check if any achievements are unlocked
        function checkAchievements() {
            let unlockedNewAchievement = false;
            for (const key in achievementsList) {
                if (achievementsList.hasOwnProperty(key)) {
                    const achievement = achievementsList[key];
                    // If not already unlocked and criteria met
                    if (!analytics.achievements[key] && achievement.criteria(analytics)) {
                        analytics.achievements[key] = true; // Mark as unlocked
                        unlockedNewAchievement = true;
                        showNotification('Achievement Unlocked!', `${achievement.emoji} ${achievement.name}`);
                        // Optionally, show a special animation for achievements
                        showAchievementPop(achievement.emoji);
                    }
                }
            }
            if (unlockedNewAchievement) {
                saveAnalytics(); // Save analytics if new achievements unlocked
                // Note: displayAchievements() is called by updateAnalytics() which is called here.
                // If you want a separate refresh, call it here. For now, it's chained.
            }
        }

        // Display unlocked achievements
        function displayAchievements() {
            const achievementsContainer = document.getElementById('achievements-list');
            const noAchievementsMsg = document.getElementById('no-achievements-msg');
            let hasUnlockedAchievements = false;

            // Hide all pre-defined achievement divs initially
            document.getElementById('achievement-first-routine').classList.add('hidden');
            document.getElementById('achievement-consistent-week').classList.add('hidden');
            document.getElementById('achievement-points-500').classList.add('hidden');
            document.getElementById('achievement-points-1000').classList.add('hidden');


            for (const key in analytics.achievements) {
                if (analytics.achievements[key] && achievementsList[key]) {
                    hasUnlockedAchievements = true;
                    // For the pre-defined divs, just unhide them
                    const predefinedDiv = document.getElementById(`achievement-${key}`);
                    if (predefinedDiv) {
                        predefinedDiv.classList.remove('hidden');
                    } else {
                        // If not pre-defined, create it dynamically (good for future custom achievements)
                        const achievementDiv = document.createElement('div');
                        achievementDiv.style.cssText = `text-align: center;`;
                        achievementDiv.innerHTML = `
                            <span style="font-size: 2.5rem;">${achievementsList[key].emoji}</span><br>
                            <span style="font-size: 0.9rem; font-weight: 600; color: var(--text-color);">${achievementsList[key].name}</span>
                        `;
                        achievementsContainer.appendChild(achievementDiv);
                    }
                }
            }

            if (hasUnlockedAchievements) {
                noAchievementsMsg.classList.add('hidden');
            } else {
                noAchievementsMsg.classList.remove('hidden');
            }
        }

        // Optional: A special pop animation for when an achievement is unlocked
        function showAchievementPop(emoji) {
            const animation = document.createElement('div');
            animation.className = 'completion-animation'; // Reusing the same class for similar effect
            animation.textContent = emoji; // Use the achievement emoji
            document.body.appendChild(animation);
            
            setTimeout(() => {
                if (document.body.contains(animation)) {
                    document.body.removeChild(animation);
                }
            }, 1500); // Display slightly longer for emphasis
        }

        // Generate weekly progress chart
        function generateWeeklyChart() {
            const chart = document.getElementById('weekly-chart');
            chart.innerHTML = ''; // Clear previous bars
            
            const maxValue = Math.max(...analytics.weeklyData, 1); // Get max value for scaling, ensure not 0
            
            analytics.weeklyData.forEach(value => {
                const bar = document.createElement('div');
                const height = (value / maxValue) * 80; // Scale height to max 80px
                bar.style.cssText = `
                    width: 20px;
                    height: ${height}px;
                    background: var(--background-gradient);
                    border-radius: 3px 3px 0 0;
                    margin-bottom: 0;
                    align-self: flex-end; /* Align bars to the bottom */
                `;
                chart.appendChild(bar);
            });
        }

        // Local Storage management
        function saveRoutines() {
            try {
                localStorage.setItem('routines', JSON.stringify(routines));
            } catch (e) {
                console.error("Error saving routines to local storage:", e);
                alert("Could not save routines. Local storage might be full or unavailable.");
            }
        }

        function saveAnalytics() {
            try {
                localStorage.setItem('analytics', JSON.stringify(analytics));
            } catch (e) {
                console.error("Error saving analytics to local storage:", e);
                alert("Could not save analytics. Local storage might be full or unavailable.");
            }
        }

        // Notification permission request
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        console.log('Notification permission granted.');
                    } else {
                        console.warn('Notification permission denied.');
                    }
                });
            }
        }

        // Show a system notification
        function showNotification(title, body) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, { body, icon: 'https://cdn-icons-png.flaticon.com/512/2927/2927063.png' }); // Generic checkmark icon
            }
        }

        // Auto-save routine progress every 5 seconds
        setInterval(() => {
            if (currentRoutine) {
                const progress = {
                    routineId: currentRoutine.id,
                    taskIndex: currentTaskIndex,
                    timeRemaining: timeRemaining,
                    isPaused: isPaused, // Save pause state
                    timestamp: Date.now()
                };
                localStorage.setItem('currentProgress', JSON.stringify(progress));
            } else {
                localStorage.removeItem('currentProgress'); // Clear if no routine is active
            }
        }, 5000);

        // Load saved progress on page load
        function loadSavedProgress() {
            const savedProgress = localStorage.getItem('currentProgress');
            if (savedProgress) {
                const progress = JSON.parse(savedProgress);
                const timeDiff = Date.now() - progress.timestamp;
                
                // Only restore if less than 1 hour (3.6 million ms) has passed to avoid stale data
                // And if the routine and task still exist
                if (timeDiff < 3600000) { 
                    const routine = routines.find(r => r.id === progress.routineId);
                    if (routine && progress.taskIndex < routine.tasks.length) {
                        currentRoutine = routine;
                        currentTaskIndex = progress.taskIndex;
                        timeRemaining = Math.max(0, progress.timeRemaining - Math.floor(timeDiff / 1000));
                        isPaused = progress.isPaused; // Restore pause state
                        
                        if (timeRemaining > 0) {
                            switchTab('timer');
                            document.getElementById('timer-inactive').classList.add('hidden');
                            document.getElementById('timer-active').classList.remove('hidden');
                            
                            document.getElementById('current-task-emoji').textContent = currentRoutine.tasks[currentTaskIndex].emoji || '‚ú®';
                            document.getElementById('current-task-name').textContent = currentRoutine.tasks[currentTaskIndex].name;
                            document.getElementById('current-task-index').textContent = currentTaskIndex + 1;
                            document.getElementById('total-tasks').textContent = currentRoutine.tasks.length;
                            
                            updateTimerDisplay();
                            updateTimerProgress();
                            updateRoutineProgress();
                            
                            if (!isPaused) { // Only start timer if it wasn't paused
                                startTimerInterval();
                            } else {
                                // Update pause button text if restored in paused state
                                document.querySelector('.timer-controls .btn.secondary').textContent = 'Resume';
                            }
                        } else {
                            // If time ran out during refresh, auto-complete the task and move to next
                            currentTaskIndex++;
                            startCurrentTask(); // This will handle if it's the last task
                        }
                    }
                }
                localStorage.removeItem('currentProgress'); // Clear after loading
            }
        }

        // Keyboard shortcuts for timer
        document.addEventListener('keydown', function(e) {
            // Only respond if on the timer tab and no modal is active
            if (document.getElementById('timer').classList.contains('active') && !document.querySelector('.modal.active')) {
                switch(e.key) {
                    case ' ': // Spacebar to pause/resume
                        e.preventDefault(); // Prevent scrolling
                        pauseTimer();
                        break;
                    case 'Enter': // Enter to complete task
                        e.preventDefault();
                        completeTask();
                        break;
                    case 'Escape': // Escape to skip task
                        e.preventDefault();
                        skipTask();
                        break;
                }
            } else if (document.getElementById('routine-modal').classList.contains('active') && e.key === 'Escape') {
                e.preventDefault();
                hideRoutineModal(); // Allow escape to close modal
            }
        });

        // Touch gestures for mobile (swipes on timer view)
        let touchStartX = 0;
        let touchStartY = 0;
        const swipeThreshold = 50; // Minimum distance for a swipe
        const angleThreshold = 45; // Max angle deviation from horizontal/vertical for a valid swipe

        document.getElementById('timer-active').addEventListener('touchstart', function(e) {
            if (e.touches.length === 1) { // Only consider single-finger touches
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
            }
        });

        document.getElementById('timer-active').addEventListener('touchend', function(e) {
            if (!currentRoutine || !document.getElementById('timer-active').classList.contains('active') || e.changedTouches.length !== 1) return;
            
            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;
            const deltaX = touchEndX - touchStartX;
            const deltaY = touchEndY - touchStartY;
            
            // Calculate angle to determine primary direction
            const angle = Math.atan2(Math.abs(deltaY), Math.abs(deltaX)) * 180 / Math.PI;

            if (Math.abs(deltaX) > swipeThreshold && angle < angleThreshold) { // Horizontal swipe
                if (deltaX > 0) { // Swipe right
                    completeTask();
                } else { // Swipe left
                    skipTask();
                }
            } else if (Math.abs(deltaY) > swipeThreshold && angle > (90 - angleThreshold)) { // Vertical swipe
                if (deltaY > 0) { // Swipe down
                    pauseTimer();
                }
                // Swipe up could be used for something else, e.g., quick reset or settings
            }
        });

        // Motivational quotes
        const motivationalQuotes = [
            "Small progress is still progress! üåü",
            "You're building great habits! üí™",
            "Consistency is key to success! üîë",
            "Every routine completed is a win! üèÜ",
            "You're doing amazing! Keep going! üöÄ",
            "Progress, not perfection! ‚ú®",
            "Building a better you, one routine at a time! üå±",
            "One step at a time! üë£",
            "You've got this! üôå"
        ];

        function showMotivationalMessage() {
            const quote = motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)];
            const message = document.createElement('div');
            message.className = 'motivational-message'; // Add a class for specific styling if needed
            message.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: var(--success-color);
                color: white;
                padding: 12px 24px;
                border-radius: var(--border-radius-btn);
                font-size: 0.9rem;
                font-weight: 600;
                z-index: 1000;
                animation: slideDown 0.5s ease-out forwards;
                pointer-events: none; /* Allow clicks to pass through */
                text-align: center;
                max-width: 90%;
            `;
            message.textContent = quote;
            document.body.appendChild(message);
            
            setTimeout(() => {
                message.style.animation = 'slideUp 0.5s ease-out forwards';
                setTimeout(() => {
                    if (document.body.contains(message)) {
                        document.body.removeChild(message);
                    }
                }, 500);
            }, 3000); // Display for 3 seconds
        }

        // Keyboard navigation accessibility (visual focus indicator)
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Tab') {
                document.body.classList.add('keyboard-navigation');
            }
        });

        document.addEventListener('mousedown', function() {
            document.body.classList.remove('keyboard-navigation');
        });

        // Service Worker registration (kept at the end of the body)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('Service Worker registered! Scope:', registration.scope);
                    })
                    .catch(err => {
                        console.error('Service Worker registration failed:', err);
                    });
            });
        }
    </script>
</body>
</html>